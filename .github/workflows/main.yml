name: get pull request info for Dingding

on:
  push:
  pull_request:

jobs:
  spring-boot:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
    - name: checkout
      uses: actions/checkout@v2
      
    # æ­¤å¤„çœç•¥å…·ä½“çš„ä¸šåŠ¡ä»£ç     
   
    # èŽ·å–PRä¿¡æ¯å¹¶å°†å…¶æ·»åŠ åˆ°çŽ¯å¢ƒå˜é‡
    - name: set PR_INFO 
      run: |
        echo PR_USER=$(jq --raw-output .compare "$GITHUB_EVENT_PATH") >> $GITHUB_ENV
        cat $GITHUB_EVENT_PATH
        echo "$(jq '.comment.id' $GITHUB_EVENT_PATH)"
        git checkout master
        git pull
        export AFTER=$(jq '.after' $GITHUB_EVENT_PATH|sed 's/\"//g')
        export BEFORE=$(jq '.before' $GITHUB_EVENT_PATH|sed 's/\"//g')
        echo $AFTER
        echo $BEFORE
        git --version
        git branch
        git show $AFTER server/pom.xml > temp
        echo 'DIFFLOG<<EOF' >> $GITHUB_ENV
        cat temp
        echo "grep result:"
        grep DIFFLOG $GITHUB_ENV
        cat temp >> $GITHUB_ENV
        echo 'EOF' >> $GITHUB_ENV
        
    # æ‰“å°çŽ¯å¢ƒå˜é‡
    - name: print env
      run: printenv
     
    # å‘é€é’‰é’‰æ¶ˆæ¯
    - name: build success
      if: ${{ success() }}
      uses: fifsky/dingtalk-action@master
      with:
        url: https://oapi.dingtalk.com/robot/send?access_token=20499910a4567a08b9bd089bb9c29ec62885f097337fbc6ce4b3558d94a5e02e
        type: text
        content: |
          # ðŸ’¯ðŸ‘¨â€ðŸ’» Success ${{ env.PR_USER }}ðŸŽ‰ðŸŽ‰ðŸŽ‰
          ${{ env.DIFFLOG }}
    - name: maven build failure
      if: ${{ failure() }}
      uses: fifsky/dingtalk-action@master
      with:
        url: https://oapi.dingtalk.com/robot/send?access_token=20499910a4567a08b9bd089bb9c29ec62885f097337fbc6ce4b3558d94a5e02e
        type: markdown
        content: |
          # ðŸ’¤ðŸ¤·â€â™€ï¸ failure ðŸ™…â€â™‚ï¸ðŸ’£
          > Maven Build of fail
          ${{ env.PR_USER }}
